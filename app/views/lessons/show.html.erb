<div class="card">
  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
    <div>
      <h2>Level <%= @lesson.level %> - Lesson <%= @lesson.order %>: <%= @lesson.title %></h2>
      <p style="font-size: 20px; color: #4ade80; margin-top: 5px;">
        <% if @lesson.level == 1 %>
          Learning BPMF Symbols
        <% elsif @lesson.level == 2 %>
          Keyboard Practice
        <% elsif @lesson.level == 3 %>
          Tone Marks & Words
        <% end %>
      </p>
    </div>
    <% if @progress.completed? %>
      <span class="badge" style="background: #00ff88; color: #000; padding: 8px 16px; border-radius: 20px; box-shadow: 0 0 10px rgba(0, 255, 136, 0.5);">Completed!</span>
    <% end %>
  </div>
  
  <% if @lesson.bpmf_symbol %>
    <div class="bpmf-symbol"><%= @lesson.bpmf_symbol %></div>
  <% end %>
  
  <% if @lesson.content %>
    <div class="examples">
      <strong>Pronunciation:</strong>
      <div class="lesson-content" style="margin-top: 10px;">
        <%= simple_format(@lesson.content) %>
      </div>
    </div>
  <% end %>
  
  <% if @lesson.pronunciation %>
    <div class="examples">
      <strong>Pinyin Equivalent:</strong> <%= @lesson.pronunciation %>
    </div>
  <% end %>
  
  <% if @lesson.examples %>
    <div class="examples">
      <strong>Examples:</strong> <%= @lesson.examples %>
    </div>
  <% end %>
  
  <% if @lesson.lesson_type == "keyboard" && @lesson.level == 2 %>
    <% unless @progress.completed? %>
      <div id="keyboard-practice" style="margin-top: 30px;">
        <h3 style="margin-bottom: 20px;">Type the BPMF symbols for: <strong style="color: #00ff88; font-size: 32px;"><%= @lesson.pronunciation %></strong></h3>
        <div id="bpmf-keyboard" style="margin: 30px 0;"></div>
        <div id="keyboard-input" style="font-size: 48px; text-align: center; min-height: 60px; padding: 20px; background: rgba(0, 0, 0, 0.5); border: 2px solid #00ff88; border-radius: 12px; margin: 20px 0; color: #00ff88; text-shadow: 0 0 10px rgba(0, 255, 136, 0.8);"></div>
        <div id="keyboard-feedback" style="display: none;"></div>
        <div style="margin-top: 20px; text-align: center;">
          <button onclick="checkKeyboardAnswer()" class="btn">Check Answer</button>
          <button onclick="clearKeyboardInput()" class="btn btn-secondary" style="margin-left: 10px;">Clear</button>
          <%= link_to "Skip to Next", @lesson.next_lesson ? lesson_path(@lesson.next_lesson.order) : lesson_path(@lesson.order), class: "btn btn-secondary", style: "margin-left: 10px;" %>
        </div>
      </div>
    <% else %>
      <div class="feedback correct" style="margin-top: 20px;">
        <strong>Great job!</strong> You've completed this lesson and earned <%= @progress.points_earned %> points!
      </div>
      
      <div style="margin-top: 30px; text-align: center;">
        <% if @next_lesson %>
          <%= link_to "Next Lesson ‚Üí", lesson_path(@next_lesson.order), class: "btn btn-success", style: "font-size: 18px; padding: 15px 30px;" %>
        <% else %>
          <p style="color: #00ff88; font-size: 18px; font-weight: 600;">üéâ Congratulations! You've completed all lessons!</p>
        <% end %>
      </div>
    <% end %>
  <% elsif (@lesson.lesson_type == "tone" || @lesson.lesson_type == "word") && @lesson.level == 3 %>
    <% unless @progress.completed? %>
      <div id="tone-practice" style="margin-top: 30px;">
        <h3 style="margin-bottom: 20px;">Combine BPMF with Tone Marks</h3>
        <div style="font-size: 36px; text-align: center; margin: 30px 0;">
          <span style="color: #00ff88; font-size: 72px; text-shadow: 0 0 20px rgba(0, 255, 136, 0.8);"><%= @lesson.bpmf_symbol %></span>
          <span style="color: #4ade80; font-size: 48px; margin-left: 15px;">+</span>
          <span style="color: #4ade80; font-size: 72px; margin-left: 15px; text-shadow: 0 0 20px rgba(74, 222, 128, 0.8);"><%= @lesson.pronunciation.last %></span>
        </div>
        <div class="examples">
          <strong>Example:</strong> <%= @lesson.examples %>
        </div>
        <div style="margin-top: 30px; text-align: center;">
          <%= form_with url: complete_lesson_path(@lesson.order), method: :post, local: true do |f| %>
            <%= f.submit "Mark as Complete", class: "btn btn-success", style: "font-size: 24px; padding: 18px 36px;" %>
          <% end %>
          <%= link_to "Skip to Next", @lesson.next_lesson ? lesson_path(@lesson.next_lesson.order) : lesson_path(@lesson.order), class: "btn btn-secondary", style: "margin-left: 10px;" %>
        </div>
      </div>
    <% else %>
      <div class="feedback correct" style="margin-top: 20px;">
        <strong>Great job!</strong> You've completed this lesson and earned <%= @progress.points_earned %> points!
      </div>
      
      <div style="margin-top: 30px; text-align: center;">
        <% if @next_lesson %>
          <%= link_to "Next Lesson ‚Üí", lesson_path(@next_lesson.order), class: "btn btn-success", style: "font-size: 18px; padding: 15px 30px;" %>
        <% else %>
          <p style="color: #00ff88; font-size: 18px; font-weight: 600;">üéâ Congratulations! You've completed all lessons!</p>
        <% end %>
      </div>
    <% end %>
  <% elsif @lesson.lesson_type == "introduction" || @lesson.lesson_type == "practice" %>
    <% unless @progress.completed? %>
      <div style="margin-top: 30px; text-align: center;">
        <% if @next_lesson %>
          <%= link_to "Continue to Next Lesson ‚Üí", lesson_path(@next_lesson.order), class: "btn btn-success", style: "font-size: 18px; padding: 15px 30px;" %>
        <% end %>
      </div>
    <% else %>
      <div class="feedback correct" style="margin-top: 20px;">
        <strong>Great job!</strong> You've completed this lesson and earned <%= @progress.points_earned %> points!
      </div>
      
      <div style="margin-top: 30px; text-align: center;">
        <% if @next_lesson %>
          <%= link_to "Next Lesson ‚Üí", lesson_path(@next_lesson.order), class: "btn btn-success", style: "font-size: 18px; padding: 15px 30px;" %>
        <% else %>
          <p style="color: #00ff88; font-size: 18px; font-weight: 600;">üéâ Congratulations! You've completed all lessons!</p>
        <% end %>
      </div>
    <% end %>
  <% elsif @lesson.bpmf_symbol || @lesson.pronunciation %>
    <% if @lesson.level == 1 %>
      <% unless @progress.completed? %>
        <div id="practice-section" style="margin-top: 30px;">
          <h3 style="margin-bottom: 15px; color: #667eea;">Practice Time!</h3>
          <p style="margin-bottom: 20px;">Enter the pinyin equivalent and select the BPMF character. Press Enter when both are correct:</p>
          
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-bottom: 30px;">
            <div>
              <label style="display: block; margin-bottom: 10px; font-size: 18px; color: #667eea;">Pinyin Equivalent:</label>
              <input type="text" 
                     id="answer-input" 
                     class="answer-input" 
                     placeholder="Enter pinyin..."
                     autocomplete="off"
                     autofocus
                     style="margin: 0;">
            </div>
            <div>
              <label style="display: block; margin-bottom: 10px; font-size: 18px; color: #667eea;">BPMF Character:</label>
              <div id="bpmf-selected" style="width: 100%; padding: 20px; font-size: 72px; text-align: center; min-height: 68px; display: flex; align-items: center; justify-content: center; background: rgba(0, 0, 0, 0.3); border: 2px dashed #4ade80; border-radius: 12px; color: #00ff88; text-shadow: 0 0 15px rgba(0, 255, 136, 0.8);"><span id="bpmf-placeholder" style="color: #4ade80; opacity: 0.5; font-size: 18px;">Click a character below</span></div>
            </div>
          </div>
          
          <div id="ready-indicator" style="display: none; text-align: center; margin: 20px 0; padding: 15px; background: rgba(0, 255, 136, 0.2); border: 2px solid #00ff88; border-radius: 10px;">
            <span style="color: #00ff88; font-size: 24px; text-shadow: 0 0 10px rgba(0, 255, 136, 0.8);">‚úì Both answers correct! Press Enter to continue ‚Üí</span>
          </div>
          
          <div id="bpmf-keyboard" style="margin: 30px 0;"></div>
          
          <div id="feedback" style="display: none; margin-top: 20px;"></div>
        </div>
      <% else %>
        <div class="feedback correct" style="margin-top: 20px;">
          <strong>Great job!</strong> You've completed this lesson and earned <%= @progress.points_earned %> points!
        </div>
        <% if @next_lesson %>
          <script>
            setTimeout(function() {
              window.location.href = '<%= lesson_path(@next_lesson.order) %>';
            }, 1500);
          </script>
        <% else %>
          <p style="color: #667eea; font-size: 18px; font-weight: 600; margin-top: 20px;">üéâ Congratulations! You've completed all lessons!</p>
        <% end %>
      <% end %>
    <% else %>
      <% unless @progress.completed? %>
        <div id="practice-section" style="margin-top: 30px;">
          <h3 style="margin-bottom: 15px; color: #667eea;">Practice Time!</h3>
          <p style="margin-bottom: 15px;">Type the pronunciation or symbol:</p>
          
          <input type="text" 
                 id="answer-input" 
                 class="answer-input" 
                 placeholder="Enter your answer here..."
                 autocomplete="off">
          
          <div id="feedback" style="display: none;"></div>
          
          <div style="margin-top: 20px;">
            <button onclick="checkAnswer()" class="btn">Check Answer</button>
            <%= link_to "Skip to Next", @lesson.next_lesson ? lesson_path(@lesson.next_lesson.order) : lesson_path(@lesson.order), class: "btn btn-secondary", style: "margin-left: 10px;" %>
          </div>
        </div>
      <% else %>
        <div class="feedback correct" style="margin-top: 20px;">
          <strong>Great job!</strong> You've completed this lesson and earned <%= @progress.points_earned %> points!
        </div>
        
        <div style="margin-top: 30px; text-align: center;">
          <% if @next_lesson %>
            <%= link_to "Next Lesson ‚Üí", lesson_path(@next_lesson.order), class: "btn btn-success", style: "font-size: 18px; padding: 15px 30px;" %>
          <% else %>
            <p style="color: #667eea; font-size: 18px; font-weight: 600;">üéâ Congratulations! You've completed all lessons!</p>
          <% end %>
        </div>
      <% end %>
    <% end %>
  <% end %>
  
  <% unless @lesson.level == 1 %>
    <div style="margin-top: 30px; display: flex; justify-content: space-between;">
      <% if @previous_lesson %>
        <%= link_to "‚Üê Previous Lesson", lesson_path(@previous_lesson.order), class: "btn btn-secondary" %>
      <% else %>
        <div></div>
      <% end %>
      
      <%= link_to "Back to Level #{@lesson.level}", level_path(@lesson.level), class: "btn btn-secondary" %>
      
      <% if @next_lesson && @progress.completed? %>
        <%= link_to "Next Lesson ‚Üí", lesson_path(@next_lesson.order), class: "btn" %>
      <% end %>
    </div>
  <% end %>
</div>

<script>
  <% if @lesson.level == 1 && !@progress.completed? %>
  let selectedBpmf = '';
  const correctPinyin = '<%= @lesson.pronunciation %>';
  const correctBpmf = '<%= @lesson.bpmf_symbol %>';
  
  // BPMF Keyboard for Level 1 - Standard Taiwanese layout
  const bpmfKeyboard = [
    ['„ÑÖ', '„Ñâ', '„Ñç', '„Ñê', '„Ñì', '„Ñó', '„Ñß', '„Ñö', '„Ñû', '„Ñ¢'],
    ['„ÑÜ', '„Ñä', '„Ñé', '„Ñë', '„Ñî', '„Ñò', '„Ñ®', '„Ñõ', '„Ñü', '„Ñ£'],
    ['„Ñá', '„Ñã', '„Ñè', '„Ñí', '„Ñï', '„Ñô', '„Ñù', '„Ñú', '„Ñ†', '„Ñ§'],
    ['„Ñà', '„Ñå', '', '', '„Ññ', '', '', '„Ñ°', '„Ñ•', '„Ñ¶']
  ];
  
  function renderBpmfKeyboard() {
    const keyboardEl = document.getElementById('bpmf-keyboard');
    keyboardEl.innerHTML = '';
    keyboardEl.style.cssText = 'display: flex; justify-content: center; gap: 15px; flex-wrap: wrap; margin: 30px 0;';
    
    const numColumns = bpmfKeyboard[0].length;
    for (let col = 0; col < numColumns; col++) {
      const colDiv = document.createElement('div');
      colDiv.style.cssText = 'display: flex; flex-direction: column; gap: 10px;';
      
      bpmfKeyboard.forEach((row, rowIndex) => {
        const symbol = row[col];
        if (symbol && symbol.trim() !== '') {
          const btn = document.createElement('button');
          btn.textContent = symbol;
          const isSelected = selectedBpmf === symbol;
          btn.style.cssText = `font-size: 36px; padding: 18px 24px; min-width: 70px; background: ${isSelected ? 'rgba(0, 255, 136, 0.6)' : 'rgba(0, 255, 136, 0.2)'}; border: 2px solid #00ff88; border-radius: 10px; color: #00ff88; cursor: pointer; transition: all 0.3s; text-shadow: 0 0 10px rgba(0, 255, 136, 0.8); display: block;`;
          btn.onmouseover = function() { 
            if (!isSelected) {
              this.style.background = 'rgba(0, 255, 136, 0.4)'; 
              this.style.boxShadow = '0 0 20px rgba(0, 255, 136, 0.6)'; 
              this.style.transform = 'scale(1.1)';
            }
          };
          btn.onmouseout = function() { 
            if (!isSelected) {
              this.style.background = 'rgba(0, 255, 136, 0.2)'; 
              this.style.boxShadow = 'none';
              this.style.transform = 'scale(1)';
            }
          };
          btn.onclick = function() { 
            selectedBpmf = symbol;
            updateBpmfDisplay();
            renderBpmfKeyboard();
          };
          colDiv.appendChild(btn);
        }
      });
      
      keyboardEl.appendChild(colDiv);
    }
  }
  
  function updateBpmfDisplay() {
    const bpmfDisplay = document.getElementById('bpmf-selected');
    const placeholder = document.getElementById('bpmf-placeholder');
    if (selectedBpmf) {
      if (placeholder) placeholder.style.display = 'none';
      bpmfDisplay.innerHTML = selectedBpmf;
    } else {
      if (placeholder) placeholder.style.display = 'inline';
      bpmfDisplay.innerHTML = '<span id="bpmf-placeholder" style="color: #4ade80; opacity: 0.5; font-size: 18px;">Click a character below</span>';
    }
    checkReadyState();
  }
  
  function checkReadyState() {
    const input = document.getElementById('answer-input');
    const readyIndicator = document.getElementById('ready-indicator');
    const pinyinAnswer = input.value.trim().toLowerCase();
    const bpmfAnswer = selectedBpmf;
    
    const pinyinCorrect = pinyinAnswer && pinyinAnswer === correctPinyin.toLowerCase();
    const bpmfCorrect = bpmfAnswer && bpmfAnswer === correctBpmf;
    
    if (pinyinCorrect && bpmfCorrect) {
      readyIndicator.style.display = 'block';
    } else {
      readyIndicator.style.display = 'none';
    }
  }
  
  function checkAnswer() {
    const input = document.getElementById('answer-input');
    const feedback = document.getElementById('feedback');
    const pinyinAnswer = input.value.trim().toLowerCase();
    const bpmfAnswer = selectedBpmf;
    
    if (!pinyinAnswer) {
      feedback.className = 'feedback incorrect';
      feedback.style.display = 'block';
      feedback.innerHTML = 'Please enter the pinyin equivalent!';
      return;
    }
    
    if (!bpmfAnswer) {
      feedback.className = 'feedback incorrect';
      feedback.style.display = 'block';
      feedback.innerHTML = 'Please select the BPMF character!';
      return;
    }
    
    const pinyinCorrect = pinyinAnswer === correctPinyin.toLowerCase();
    const bpmfCorrect = bpmfAnswer === correctBpmf;
    
    if (pinyinCorrect && bpmfCorrect) {
      // Both correct - submit to server
      const lessonOrder = <%= @lesson.order %>;
      const nextLessonPath = '<%= @next_lesson ? lesson_path(@next_lesson.order) : nil %>';
      const readyIndicator = document.getElementById('ready-indicator');
      
      fetch(`/lessons/${lessonOrder}/submit_answer`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').content
        },
        body: JSON.stringify({ answer: pinyinAnswer })
      })
      .then(response => response.json())
      .then(data => {
        feedback.style.display = 'block';
        feedback.className = 'feedback correct';
        feedback.innerHTML = `<strong>Perfect! Both answers are correct!</strong> You earned ${data.points} points!`;
        input.disabled = true;
        readyIndicator.style.display = 'none';
        
        if (data.completed && nextLessonPath) {
          setTimeout(() => {
            window.location.href = nextLessonPath;
          }, 1000);
        }
      })
      .catch(error => {
        feedback.className = 'feedback incorrect';
        feedback.style.display = 'block';
        feedback.innerHTML = 'Something went wrong. Please try again.';
        readyIndicator.style.display = 'none';
      });
    } else {
      // One or both incorrect
      const readyIndicator = document.getElementById('ready-indicator');
      readyIndicator.style.display = 'none';
      feedback.className = 'feedback incorrect';
      feedback.style.display = 'block';
      let message = '<strong>Not quite right:</strong><br>';
      if (!pinyinCorrect) {
        message += `Pinyin: "${pinyinAnswer}" is incorrect. Correct answer: "${correctPinyin}"<br>`;
        input.value = '';
      }
      if (!bpmfCorrect) {
        message += `BPMF: "${bpmfAnswer}" is incorrect. Correct answer: "${correctBpmf}"<br>`;
        selectedBpmf = '';
        updateBpmfDisplay();
        renderBpmfKeyboard();
      }
      feedback.innerHTML = message;
      input.focus();
    }
  }
  
  // Allow Enter key to submit from anywhere
  document.addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
      e.preventDefault();
      checkAnswer();
    }
  });
  
  // Check ready state when pinyin input changes
  document.getElementById('answer-input')?.addEventListener('input', function() {
    checkReadyState();
  });
  
  // Initialize keyboard and display
  document.addEventListener('DOMContentLoaded', function() {
    renderBpmfKeyboard();
    updateBpmfDisplay();
    const input = document.getElementById('answer-input');
    if (input) {
      input.focus();
    }
  });
  <% else %>
  function checkAnswer() {
    const input = document.getElementById('answer-input');
    const feedback = document.getElementById('feedback');
    const answer = input.value.trim();
    
    if (!answer) {
      feedback.className = 'feedback incorrect';
      feedback.style.display = 'block';
      feedback.innerHTML = 'Please enter an answer!';
      return;
    }
    
    const lessonOrder = <%= @lesson.order %>;
    const lessonLevel = <%= @lesson.level %>;
    const correctAnswer = '<%= @lesson.pronunciation || @lesson.bpmf_symbol %>';
    const nextLessonPath = '<%= @next_lesson ? lesson_path(@next_lesson.order) : nil %>';
    
    fetch(`/lessons/${lessonOrder}/submit_answer`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').content
      },
      body: JSON.stringify({ answer: answer })
    })
    .then(response => response.json())
    .then(data => {
      feedback.style.display = 'block';
      
      if (data.correct) {
        feedback.className = 'feedback correct';
        feedback.innerHTML = `<strong>${data.message}</strong> You earned ${data.points} points!`;
        input.disabled = true;
        
        if (data.completed) {
          if (lessonLevel == 1 && nextLessonPath) {
            setTimeout(() => {
              window.location.href = nextLessonPath;
            }, 1000);
          } else {
            setTimeout(() => {
              window.location.reload();
            }, 2000);
          }
        }
      } else {
        feedback.className = 'feedback incorrect';
        feedback.innerHTML = `<strong>${data.message}</strong> ${data.hint ? '<br>' + data.hint : ''}`;
        input.value = '';
        input.focus();
      }
    })
    .catch(error => {
      feedback.className = 'feedback incorrect';
      feedback.style.display = 'block';
      feedback.innerHTML = 'Something went wrong. Please try again.';
    });
  }
  
  document.getElementById('answer-input')?.addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
      checkAnswer();
    }
  });
  <% end %>
  
  // BPMF Keyboard for Level 2 - Standard Taiwanese layout (top-to-bottom, left-to-right)
  <% if @lesson.lesson_type == "keyboard" && @lesson.level == 2 %>
  let keyboardInput = '';
  // Standard BPMF keyboard layout: columns from left to right, symbols top to bottom in each column
  const bpmfKeyboard = [
    ['„ÑÖ', '„Ñâ', '„Ñç', '„Ñê', '„Ñì', '„Ñó', '„Ñß', '„Ñö', '„Ñû', '„Ñ¢'],
    ['„ÑÜ', '„Ñä', '„Ñé', '„Ñë', '„Ñî', '„Ñò', '„Ñ®', '„Ñõ', '„Ñü', '„Ñ£'],
    ['„Ñá', '„Ñã', '„Ñè', '„Ñí', '„Ñï', '„Ñô', '„Ñù', '„Ñú', '„Ñ†', '„Ñ§'],
    ['„Ñà', '„Ñå', '', '', '„Ññ', '', '', '„Ñ°', '„Ñ•', '„Ñ¶']
  ];
  
  function renderKeyboard() {
    const keyboardEl = document.getElementById('bpmf-keyboard');
    keyboardEl.innerHTML = '';
    keyboardEl.style.cssText = 'display: flex; justify-content: center; gap: 15px; flex-wrap: wrap; margin: 30px 0;';
    
    // Tone marks mapping: column index => tone mark
    const toneMarks = {
      2: 'Àá',  // Third tone above column 3 (index 2) - dipping tone (down then up)
      3: 'Àã',  // Fourth tone above column 4 (index 3) - falling tone
      5: 'Àä',  // Second tone above column 6 (index 5) - rising tone
      6: '¬∑'   // Fifth tone (neutral) above column 7 (index 6) - dot („Ñß, „Ñ®, „Ñù)
      // Column 8 (index 7) has no tone mark - „Ñö, „Ñõ, „Ñú, „Ñ°
      // Column 9 (index 8) has no tone mark - „Ñû, „Ñü, „Ñ†, „Ñ•
      // Column 10 (index 9) has no tone mark - „Ñ¢, „Ñ£, „Ñ§, „Ñ¶
    };
    
    // Render columns (left to right)
    const numColumns = bpmfKeyboard[0].length;
    for (let col = 0; col < numColumns; col++) {
      const colDiv = document.createElement('div');
      colDiv.style.cssText = 'display: flex; flex-direction: column; gap: 10px;';
      
      // Add tone mark above column if specified
      if (toneMarks[col]) {
        const toneBtn = document.createElement('button');
        toneBtn.textContent = toneMarks[col];
        toneBtn.style.cssText = 'font-size: 28px; padding: 12px 24px; min-width: 70px; background: rgba(74, 222, 128, 0.3); border: 2px solid #4ade80; border-radius: 10px; color: #4ade80; cursor: pointer; transition: all 0.3s; text-shadow: 0 0 10px rgba(74, 222, 128, 0.8); display: block; margin-bottom: 5px;';
        toneBtn.onmouseover = function() { 
          this.style.background = 'rgba(74, 222, 128, 0.5)'; 
          this.style.boxShadow = '0 0 20px rgba(74, 222, 128, 0.6)'; 
          this.style.transform = 'scale(1.1)';
        };
        toneBtn.onmouseout = function() { 
          this.style.background = 'rgba(74, 222, 128, 0.3)'; 
          this.style.boxShadow = 'none';
          this.style.transform = 'scale(1)';
        };
        toneBtn.onclick = function() { 
          keyboardInput += toneMarks[col];
          updateKeyboardDisplay();
        };
        colDiv.appendChild(toneBtn);
      }
      
      // Render symbols in this column (top to bottom)
      bpmfKeyboard.forEach((row, rowIndex) => {
        const symbol = row[col];
        if (symbol && symbol.trim() !== '') {
          const btn = document.createElement('button');
          btn.textContent = symbol;
          btn.style.cssText = 'font-size: 36px; padding: 18px 24px; min-width: 70px; background: rgba(0, 255, 136, 0.2); border: 2px solid #00ff88; border-radius: 10px; color: #00ff88; cursor: pointer; transition: all 0.3s; text-shadow: 0 0 10px rgba(0, 255, 136, 0.8); display: block;';
          btn.onmouseover = function() { 
            this.style.background = 'rgba(0, 255, 136, 0.4)'; 
            this.style.boxShadow = '0 0 20px rgba(0, 255, 136, 0.6)'; 
            this.style.transform = 'scale(1.1)';
          };
          btn.onmouseout = function() { 
            this.style.background = 'rgba(0, 255, 136, 0.2)'; 
            this.style.boxShadow = 'none';
            this.style.transform = 'scale(1)';
          };
          btn.onclick = function() { 
            keyboardInput += symbol;
            updateKeyboardDisplay();
          };
          colDiv.appendChild(btn);
        }
      });
      
      keyboardEl.appendChild(colDiv);
    }
  }
  
  function updateKeyboardDisplay() {
    document.getElementById('keyboard-input').textContent = keyboardInput || ' ';
  }
  
  function clearKeyboardInput() {
    keyboardInput = '';
    updateKeyboardDisplay();
  }
  
  function checkKeyboardAnswer() {
    const feedback = document.getElementById('keyboard-feedback');
    const correctAnswer = '<%= @lesson.bpmf_symbol %>';
    
    if (keyboardInput === correctAnswer) {
      feedback.className = 'feedback correct';
      feedback.style.display = 'block';
      feedback.innerHTML = '<strong>Correct!</strong> Great job!';
      
      const lessonOrder = <%= @lesson.order %>;
      fetch(`/lessons/${lessonOrder}/submit_answer`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').content
        },
        body: JSON.stringify({ answer: keyboardInput })
      })
      .then(response => response.json())
      .then(data => {
        if (data.completed) {
          setTimeout(() => {
            window.location.reload();
          }, 2000);
        }
      });
    } else {
      feedback.className = 'feedback incorrect';
      feedback.style.display = 'block';
      feedback.innerHTML = '<strong>Not quite.</strong> Try again! The correct answer is: ' + correctAnswer;
      clearKeyboardInput();
    }
  }
  
  renderKeyboard();
  updateKeyboardDisplay();
  <% end %>
</script>

